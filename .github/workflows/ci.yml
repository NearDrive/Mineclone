name: CI

on:
  push:
  pull_request:

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xorg-dev libgl1-mesa-dev xvfb gdb

      - name: Configure Release
        run: |
          success=0
          for attempt in 1 2 3; do
            if cmake -S . -B build-release -DCMAKE_BUILD_TYPE=Release; then
              success=1
              break
            fi
            echo "Configure Release failed (attempt ${attempt}). Retrying..." >&2
            sleep 5
          done
          if [ "$success" -ne 1 ]; then
            exit 1
          fi

      - name: Build Release
        run: cmake --build build-release --config Release

      - name: Configure Debug
        run: |
          success=0
          for attempt in 1 2 3; do
            if cmake -S . -B build-debug -DCMAKE_BUILD_TYPE=Debug; then
              success=1
              break
            fi
            echo "Configure Debug failed (attempt ${attempt}). Retrying..." >&2
            sleep 5
          done
          if [ "$success" -ne 1 ]; then
            exit 1
          fi

      - name: Build Debug
        run: cmake --build build-debug --config Debug

      - name: Smoke Test (Debug)
        run: xvfb-run -a ./build-debug/Mineclone --smoke-test --no-gl-debug

      - name: Soak Test (Debug)
        run: |
          set -e
          set -o pipefail
          mkdir -p ci_artifacts
          xvfb-run -a ./build-debug/Mineclone --soak-test --no-gl-debug | tee ci_artifacts/soak_general_log.txt
          python - <<'PY'
import pathlib
log_path = pathlib.Path("ci_artifacts/soak_general_log.txt")
lines = log_path.read_text().splitlines()
top = None
bottom = None
for i, line in enumerate(lines):
    if line.startswith("+--------------------------+") and i + 1 < len(lines):
        if "| Metric" in lines[i + 1]:
            top = i
for i in range(len(lines) - 1, -1, -1):
    if "final_checksum_sha256" in lines[i]:
        for j in range(i, len(lines)):
            if lines[j].startswith("+--------------------------+"):
                bottom = j
                break
        break
if top is not None and bottom is not None and bottom >= top:
    summary = "\n".join(lines[top:bottom + 1]) + "\n"
    pathlib.Path("ci_artifacts/soak_general_summary.txt").write_text(summary)
else:
    pathlib.Path("ci_artifacts/soak_general_summary.txt").write_text("Summary table not found.\n")
PY

      - name: Interaction Test (Debug)
        run: |
          set -e
          set -o pipefail
          xvfb-run -a ./build-debug/Mineclone --interaction-test --no-gl-debug | tee interaction_test_log.txt

      - name: World Test (Debug)
        run: ./build-debug/Mineclone --world-test

      - name: Render Test (Debug)
        run: |
          ulimit -c unlimited
          set +e
          xvfb-run -a ./build-debug/Mineclone --render-test --render-test-out render_test.png --render-test-size 256 256 --render-test-frames 3 --render-test-seed 1337 --no-gl-debug > render_test.log 2>&1
          status=$?
          cat render_test.log
          exit $status

      - name: Soak Test Long (Debug)
        run: |
          set -e
          set -o pipefail
          mkdir -p ci_artifacts
          xvfb-run -a ./build-debug/Mineclone --soak-test-long --no-gl-debug | tee ci_artifacts/soak_long_log.txt
          python - <<'PY'
import pathlib
log_path = pathlib.Path("ci_artifacts/soak_long_log.txt")
lines = log_path.read_text().splitlines()
top = None
bottom = None
for i, line in enumerate(lines):
    if line.startswith("+--------------------------+") and i + 1 < len(lines):
        if "| Metric" in lines[i + 1]:
            top = i
for i in range(len(lines) - 1, -1, -1):
    if "final_checksum_sha256" in lines[i]:
        for j in range(i, len(lines)):
            if lines[j].startswith("+--------------------------+"):
                bottom = j
                break
        break
if top is not None and bottom is not None and bottom >= top:
    summary = "\n".join(lines[top:bottom + 1]) + "\n"
    pathlib.Path("ci_artifacts/soak_long_summary.txt").write_text(summary)
else:
    pathlib.Path("ci_artifacts/soak_long_summary.txt").write_text("Summary table not found.\n")
PY

      - name: Upload Render Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: render-test-logs
          path: |
            render_test.log
            core*

      - name: Upload Interaction Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: interaction-test-logs
          path: interaction_test_log.txt
      
      - name: Upload Soak Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: soak-test-logs
          path: |
            ci_artifacts/soak_general_log.txt
            ci_artifacts/soak_general_summary.txt
            ci_artifacts/soak_long_log.txt
            ci_artifacts/soak_long_summary.txt

      - name: Upload Render Test Images
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: render-test-images
          path: render_test_scene*.png

      - name: Render Test (Debug) Backtrace
        if: always()
        continue-on-error: true
        run: |
          ls -al core* || true
          xvfb-run -a gdb --batch -ex "set pagination off" -ex "run" -ex "bt full" \
            --args ./build-debug/Mineclone --render-test --render-test-out render_test.png --render-test-size 256 256 --render-test-frames 3 --render-test-seed 1337 --no-gl-debug

  linux-sanitize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xorg-dev libgl1-mesa-dev xvfb

      - name: Configure Sanitizers
        run: |
          success=0
          for attempt in 1 2 3; do
            if cmake -S . -B build-sanitize -DCMAKE_BUILD_TYPE=Debug -DMINECLONE_SANITIZE=ON; then
              success=1
              break
            fi
            echo "Configure Sanitizers failed (attempt ${attempt}). Retrying..." >&2
            sleep 5
          done
          if [ "$success" -ne 1 ]; then
            exit 1
          fi

      - name: Build Sanitizers
        run: cmake --build build-sanitize --config Debug

      - name: Smoke Test (Sanitizers)
        env:
          LSAN_OPTIONS: suppressions=ci/lsan.supp
        run: xvfb-run -a ./build-sanitize/Mineclone --smoke-test --no-gl-debug

      - name: Soak Test (Sanitizers)
        env:
          LSAN_OPTIONS: suppressions=ci/lsan.supp
        run: xvfb-run -a ./build-sanitize/Mineclone --soak-test --no-gl-debug

      - name: Interaction Test (Sanitizers)
        env:
          LSAN_OPTIONS: suppressions=ci/lsan.supp
        run: |
          set -e
          set -o pipefail
          xvfb-run -a ./build-sanitize/Mineclone --interaction-test --no-gl-debug | tee interaction_test_sanitize_log.txt

  windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Release
        run: cmake -S . -B build

      - name: Build Release
        run: cmake --build build --config Release
