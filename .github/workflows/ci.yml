name: CI

on:
  push:
  pull_request:

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xorg-dev libgl1-mesa-dev xvfb

      - name: Configure Release
        run: cmake -S . -B build-release -DCMAKE_BUILD_TYPE=Release

      - name: Build Release
        run: cmake --build build-release --config Release

      - name: Configure Debug
        run: cmake -S . -B build-debug -DCMAKE_BUILD_TYPE=Debug

      - name: Build Debug
        run: cmake --build build-debug --config Debug

      - name: Smoke Test (Debug)
        run: xvfb-run -a ./build-debug/Mineclone --smoke-test --no-gl-debug

      - name: Render Test (Debug)
        run: xvfb-run -a ./build-debug/Mineclone --render-test --render-test-out render_test.png --render-test-size 256 256 --render-test-frames 3 --render-test-seed 1337 --no-gl-debug

      - name: Render Test (Debug) Logs
        run: |
          ulimit -c unlimited
          xvfb-run -a ./build-debug/Mineclone --render-test --render-test-out render_test.png --render-test-size 256 256 --render-test-frames 3 --render-test-seed 1337 --no-gl-debug > render_test.log 2>&1 || true
          echo "=== render_test.log ==="
          cat render_test.log
          echo "=== core files ==="
          ls -al core* || true

      - name: Render Test (Debug) Backtrace
        run: |
          gdb --batch -ex "set pagination off" -ex "run" -ex "bt full" \
            --args ./build-debug/Mineclone --render-test --render-test-out render_test.png --render-test-size 256 256 --render-test-frames 3 --render-test-seed 1337 --no-gl-debug

      - name: Upload Render Test Logs
        uses: actions/upload-artifact@v4
        with:
          name: render-test-logs
          path: |
            render_test.log
            core*

      - name: Upload Render Test Artifact
        uses: actions/upload-artifact@v4
        with:
          name: render-test-linux
          path: render_test.png

  linux-sanitize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xorg-dev libgl1-mesa-dev xvfb

      - name: Configure Sanitizers
        run: cmake -S . -B build-sanitize -DCMAKE_BUILD_TYPE=Debug -DMINECLONE_SANITIZE=ON

      - name: Build Sanitizers
        run: cmake --build build-sanitize --config Debug

      - name: Smoke Test (Sanitizers)
        env:
          LSAN_OPTIONS: suppressions=ci/lsan.supp
        run: xvfb-run -a ./build-sanitize/Mineclone --smoke-test --no-gl-debug

  windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Release
        run: cmake -S . -B build

      - name: Build Release
        run: cmake --build build --config Release
